<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>背单词</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", sans-serif;
        background: #f8f9fa;
        color: #333;
        line-height: 1.6;
        overflow-x: hidden;
      }

      .container {
        max-width: 100vw;
        min-height: 100vh;
        background: white;
      }

      .header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header h1 {
        font-size: 20px;
        font-weight: 600;
        color: #333;
      }

      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .sync-status {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 12px;
        background: #e9ecef;
        color: #6c757d;
      }

      .sync-status.syncing {
        background: #fff3cd;
        color: #856404;
      }

      .sync-status.synced {
        background: #d4edda;
        color: #155724;
      }

      .sync-status.error {
        background: #f8d7da;
        color: #721c24;
      }

      .add-group-btn {
        width: 36px;
        height: 36px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #6c757d;
        transition: all 0.2s ease;
        touch-action: manipulation;
      }

      .add-group-btn:hover,
      .add-group-btn:active {
        border-color: #333;
        color: #333;
        transform: scale(0.95);
      }

      .tab-container {
        border-bottom: 1px solid #e9ecef;
        background: white;
        position: sticky;
        top: var(--header-height, 60px);
        z-index: 99;
      }

      .tabs {
        display: flex;
        padding: 0 16px;
      }

      .tab {
        flex: 1;
        padding: 14px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.2s ease;
        text-align: center;
        touch-action: manipulation;
      }

      .tab:active {
        transform: scale(0.98);
      }

      .tab.active {
        color: #333;
        border-bottom-color: #333;
      }

      .main-content {
        display: block;
        min-height: calc(100vh - 120px);
      }

      .sidebar {
        width: 100%;
        background: #fafbfc;
        border-bottom: 1px solid #e9ecef;
        padding: 16px 0;
        max-height: 200px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .group-list-container {
        display: flex;
        gap: 12px;
        padding: 0 16px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .group-list-container::-webkit-scrollbar {
        display: none;
      }

      .group-item {
        min-width: 120px;
        padding: 12px 16px;
        cursor: pointer;
        border: 1px solid #e9ecef;
        border-radius: 20px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        background: white;
        touch-action: manipulation;
        white-space: nowrap;
      }

      .group-item:active {
        transform: scale(0.95);
      }

      .group-item.active {
        background: #333;
        color: white;
        border-color: #333;
      }

      .group-name {
        font-weight: 500;
        font-size: 14px;
      }

      .group-count {
        font-size: 12px;
        opacity: 0.8;
      }

      .content-area {
        padding: 16px;
      }

      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
      }

      .content-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        flex: 1;
        min-width: 0;
      }

      .controls {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .toggle-btn {
        padding: 6px 12px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 16px;
        cursor: pointer;
        font-size: 12px;
        color: #6c757d;
        transition: all 0.2s ease;
        touch-action: manipulation;
        white-space: nowrap;
      }

      .toggle-btn:active {
        transform: scale(0.95);
      }

      .toggle-btn.active {
        background: #333;
        color: white;
        border-color: #333;
      }

      .add-word-form {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        display: none;
      }

      .add-word-form.show {
        display: block;
      }

      .form-row {
        margin-bottom: 12px;
      }

      .form-row:last-child {
        margin-bottom: 0;
      }

      input[type="text"],
      textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        transition: border-color 0.2s ease;
        -webkit-appearance: none;
      }

      input[type="text"]:focus,
      textarea:focus {
        outline: none;
        border-color: #333;
      }

      .form-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      .btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        touch-action: manipulation;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn-primary {
        background: #333;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .stat-item {
        text-align: center;
        padding: 16px 12px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .stat-number {
        font-size: 20px;
        font-weight: 600;
        color: #333;
      }

      .stat-label {
        font-size: 11px;
        color: #6c757d;
        margin-top: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .word-list {
        display: grid;
        gap: 12px;
      }

      .word-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
      }

      .word-card:active {
        transform: scale(0.98);
      }

      .word-content {
        margin-bottom: 12px;
      }

      .word-text {
        padding: 12px 16px;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: 44px;
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 16px;
        touch-action: manipulation;
      }

      .word-text:last-child {
        margin-bottom: 0;
      }

      .word-text.hidden {
        background: #e9ecef;
        color: transparent;
        text-shadow: 0 0 8px #666;
        user-select: none;
        position: relative;
      }

      .word-text.hidden::after {
        content: "点击显示";
        color: #6c757d;
        font-size: 12px;
        text-shadow: none;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      .word-text:active {
        transform: scale(0.98);
      }

      .word-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-buttons {
        display: flex;
        gap: 8px;
      }

      .status-btn {
        width: 40px;
        height: 40px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s ease;
        touch-action: manipulation;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .status-btn:active {
        transform: scale(0.9);
      }

      .status-btn.familiar {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
      }

      .status-btn.unfamiliar {
        background: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
      }

      .delete-btn {
        width: 40px;
        height: 40px;
        border: 1px solid #f5c6cb;
        background: #f8d7da;
        color: #721c24;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s ease;
        touch-action: manipulation;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-btn:active {
        transform: scale(0.9);
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
      }

      .empty-state h3 {
        margin-bottom: 8px;
        font-size: 16px;
        font-weight: 500;
      }

      .empty-state p {
        font-size: 14px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        width: 100%;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        gap: 12px;
      }

      .github-config {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
      }

      .github-config h4 {
        margin-bottom: 12px;
        font-size: 14px;
        color: #333;
      }

      .github-config input {
        margin-bottom: 8px;
      }

      .github-config .help-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 8px;
      }

      .radio-group {
        display: flex;
        gap: 16px;
        margin-top: 8px;
      }

      .radio-item {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      /* 移动端优化 */
      @media (max-width: 768px) {
        .header {
          padding: 10px 16px;
        }

        .header h1 {
          font-size: 18px;
        }

        .content-header {
          flex-direction: column;
          align-items: stretch;
          gap: 16px;
        }

        .controls {
          justify-content: center;
        }

        .toggle-btn {
          font-size: 11px;
          padding: 8px 12px;
        }

        .word-text {
          font-size: 15px;
          padding: 16px;
          min-height: 50px;
        }

        .status-btn,
        .delete-btn {
          width: 44px;
          height: 44px;
          font-size: 18px;
        }

        .stats {
          grid-template-columns: repeat(3, 1fr);
          gap: 8px;
        }

        .stat-item {
          padding: 12px 8px;
        }

        .stat-number {
          font-size: 18px;
        }

        .modal-content {
          margin: 20px;
          padding: 20px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 16px;
        }

        .add-group-btn {
          width: 32px;
          height: 32px;
          font-size: 16px;
        }

        .content-area {
          padding: 12px;
        }

        .word-card {
          padding: 12px;
        }

        .controls {
          gap: 4px;
        }

        .toggle-btn {
          font-size: 10px;
          padding: 6px 10px;
        }
      }

      /* 暗色模式支持 */
      @media (prefers-color-scheme: dark) {
        body {
          background: #121212;
          color: #e0e0e0;
        }

        .container,
        .header,
        .tab-container {
          background: #1e1e1e;
        }

        .sidebar {
          background: #2a2a2a;
        }

        .group-item {
          background: #2a2a2a;
          border-color: #404040;
          color: #e0e0e0;
        }

        .group-item.active {
          background: #fff;
          color: #333;
        }

        .word-card,
        .add-word-form,
        .modal-content {
          background: #2a2a2a;
          border-color: #404040;
        }

        input[type="text"],
        textarea {
          background: #1e1e1e;
          border-color: #404040;
          color: #e0e0e0;
        }

        .word-text {
          background: #1e1e1e;
        }

        .stat-item {
          background: #1e1e1e;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>背单词</h1>
        <div class="header-actions">
          <div class="sync-status" id="syncStatus">未同步</div>
          <button class="add-group-btn" onclick="showAddGroupModal()">+</button>
        </div>
      </div>

      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-type="words">单词</div>
          <div class="tab" data-type="phrases">短语</div>
        </div>
      </div>

      <div class="main-content">
        <div class="sidebar">
          <div class="group-list-container" id="groupList"></div>
        </div>

        <div class="content-area">
          <div class="content-header">
            <h2 class="content-title" id="contentTitle">选择组别</h2>
            <div class="controls">
              <button
                class="toggle-btn"
                id="hideChinese"
                onclick="toggleHideMode('chinese')"
              >
                隐藏中文
              </button>
              <button
                class="toggle-btn"
                id="hideEnglish"
                onclick="toggleHideMode('english')"
              >
                隐藏英文
              </button>
              <button
                class="toggle-btn"
                id="switchLang"
                onclick="switchLanguage()"
              >
                中英互换
              </button>
              <button
                class="toggle-btn"
                id="filterBtn"
                onclick="toggleUnfamiliarFilter()"
              >
                仅显示不熟
              </button>
            </div>
          </div>

          <div class="add-word-form" id="addWordForm">
            <div class="form-row">
              <input type="text" id="englishWord" placeholder="英文单词/短语" />
            </div>
            <div class="form-row">
              <input type="text" id="chineseMeaning" placeholder="中文释义" />
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" onclick="addWord()">添加</button>
              <button class="btn btn-secondary" onclick="hideAddWordForm()">
                取消
              </button>
            </div>
          </div>

          <div class="stats" id="stats" style="display: none">
            <div class="stat-item">
              <div class="stat-number" id="totalWords">0</div>
              <div class="stat-label">总数</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="familiarWords">0</div>
              <div class="stat-label">已掌握</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="unfamiliarWords">0</div>
              <div class="stat-label">待复习</div>
            </div>
          </div>

          <div id="wordsList">
            <div class="empty-state">
              <h3>选择或创建组别开始学习</h3>
              <p>点击右上角的 + 号添加新的单词组或短语组</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加组别模态框 -->
    <div class="modal" id="addGroupModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">添加新组别</h3>
        </div>
        <div class="modal-body">
          <div class="github-config" id="githubConfig" style="display: none">
            <h4>GitHub 同步配置</h4>
            <input
              type="text"
              id="githubToken"
              placeholder="GitHub Personal Access Token"
              style="width: 100%; margin-bottom: 8px"
            />
            <input
              type="text"
              id="githubRepo"
              placeholder="用户名/仓库名 (例: username/vocabulary)"
              style="width: 100%; margin-bottom: 8px"
            />
            <div class="help-text">
              需要在 GitHub 设置中创建 Personal Access Token，权限需要包含
              repo。<br />
              仓库会自动创建，如果已存在会直接使用。
            </div>
          </div>
          <input
            type="text"
            id="groupName"
            placeholder="输入组别名称"
            style="width: 100%; margin-bottom: 16px"
          />
          <div>
            <label
              style="
                display: block;
                margin-bottom: 8px;
                color: #6c757d;
                font-size: 14px;
              "
              >类型:</label
            >
            <div class="radio-group">
              <label class="radio-item">
                <input type="radio" name="groupType" value="words" checked />
                <span>单词</span>
              </label>
              <label class="radio-item">
                <input type="radio" name="groupType" value="phrases" />
                <span>短语</span>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="hideAddGroupModal()">
            取消
          </button>
          <button class="btn btn-primary" onclick="addGroup()">创建</button>
        </div>
      </div>
    </div>

    <script>
      class VocabularyApp {
        constructor() {
          this.data = {
            words: JSON.parse(localStorage.getItem("vocabularyWords")) || {},
            phrases:
              JSON.parse(localStorage.getItem("vocabularyPhrases")) || {},
          };
          this.currentType = "words";
          this.currentGroup = "";
          this.hideMode = "none";
          this.isLanguageSwitched = false;
          this.showOnlyUnfamiliar = false;
          this.githubToken = localStorage.getItem("githubToken") || "";
          this.githubRepo = localStorage.getItem("githubRepo") || "";
          this.syncInProgress = false;

          this.init();
          this.setupGitHubSync();
        }

        init() {
          this.updateTabs();
          this.updateGroupList();
          this.displayContent();
          this.setupEventListeners();
          this.checkGitHubConfig();
        }

        setupEventListeners() {
          // 触摸事件优化
          document.addEventListener("touchstart", function () {}, {
            passive: true,
          });

          // 模态框点击外部关闭
          document
            .getElementById("addGroupModal")
            .addEventListener("click", (e) => {
              if (e.target === e.currentTarget) {
                this.hideAddGroupModal();
              }
            });

          // 回车键事件
          document
            .getElementById("chineseMeaning")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                this.addWord();
              }
            });

          document
            .getElementById("groupName")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                this.addGroup();
              }
            });

          // 防止页面缩放
          document.addEventListener("gesturestart", function (e) {
            e.preventDefault();
          });
        }

        checkGitHubConfig() {
          if (!this.githubToken || !this.githubRepo) {
            document.getElementById("githubConfig").style.display = "block";
            document.getElementById("githubToken").value = this.githubToken;
            document.getElementById("githubRepo").value = this.githubRepo;
          }
        }

        updateTabs() {
          document.querySelectorAll(".tab").forEach((tab) => {
            tab.classList.toggle(
              "active",
              tab.dataset.type === this.currentType
            );
            tab.onclick = () => this.switchType(tab.dataset.type);
          });
        }

        switchType(type) {
          this.currentType = type;
          this.currentGroup = "";
          this.updateTabs();
          this.updateGroupList();
          this.displayContent();
        }

        showAddGroupModal() {
          document.getElementById("addGroupModal").classList.add("show");
          document.getElementById("groupName").focus();
        }

        hideAddGroupModal() {
          document.getElementById("addGroupModal").classList.remove("show");
          document.getElementById("groupName").value = "";
        }

        async addGroup() {
          const groupName = document.getElementById("groupName").value.trim();
          const groupType = document.querySelector(
            'input[name="groupType"]:checked'
          ).value;

          // 保存GitHub配置
          const token = document.getElementById("githubToken").value.trim();
          const repo = document.getElementById("githubRepo").value.trim();

          if (token && repo) {
            this.githubToken = token;
            this.githubRepo = repo;
            localStorage.setItem("githubToken", token);
            localStorage.setItem("githubRepo", repo);
          }

          if (!groupName) {
            alert("请输入组别名称");
            return;
          }

          if (this.data[groupType][groupName]) {
            alert("组别已存在");
            return;
          }

          this.data[groupType][groupName] = [];
          this.currentType = groupType;
          this.currentGroup = groupName;

          await this.saveData();
          this.updateTabs();
          this.updateGroupList();
          this.displayContent();
          this.hideAddGroupModal();
        }

        updateGroupList() {
          const groupList = document.getElementById("groupList");
          const groups = this.data[this.currentType];

          if (Object.keys(groups).length === 0) {
            groupList.innerHTML =
              '<div style="padding: 20px; text-align: center; color: #6c757d; font-size: 14px;">暂无组别</div>';
            return;
          }

          groupList.innerHTML = "";
          Object.keys(groups).forEach((groupName) => {
            const groupItem = document.createElement("div");
            groupItem.className = `group-item ${
              this.currentGroup === groupName ? "active" : ""
            }`;
            groupItem.innerHTML = `
                        <span class="group-name">${groupName}</span>
                        <span class="group-count">${groups[groupName].length}</span>
                    `;
            groupItem.onclick = () => {
              this.currentGroup = groupName;
              this.updateGroupList();
              this.displayContent();
            };
            groupList.appendChild(groupItem);
          });

          // 如果没有选中的组别，默认选中第一个
          if (!this.currentGroup && Object.keys(groups).length > 0) {
            this.currentGroup = Object.keys(groups)[0];
            this.updateGroupList();
            this.displayContent();
          }
        }

        displayContent() {
          const contentTitle = document.getElementById("contentTitle");
          const addWordForm = document.getElementById("addWordForm");
          const stats = document.getElementById("stats");
          const wordsList = document.getElementById("wordsList");

          if (!this.currentGroup) {
            contentTitle.textContent = "选择组别";
            addWordForm.style.display = "none";
            stats.style.display = "none";
            wordsList.innerHTML = `
                        <div class="empty-state">
                            <h3>选择或创建组别开始学习</h3>
                            <p>点击右上角的 + 号添加新的${
                              this.currentType === "words" ? "单词" : "短语"
                            }组</p>
                        </div>
                    `;
            return;
          }

          contentTitle.textContent = this.currentGroup;
          addWordForm.classList.add("show");
          stats.style.display = "grid";

          const words = this.data[this.currentType][this.currentGroup] || [];
          this.displayWords(words);
          this.updateStats(words);
        }

        displayWords(words) {
          const wordsList = document.getElementById("wordsList");

          if (words.length === 0) {
            wordsList.innerHTML = `
                        <div class="empty-state">
                            <h3>还没有${
                              this.currentType === "words" ? "单词" : "短语"
                            }</h3>
                            <p>在上方输入框中添加新的${
                              this.currentType === "words" ? "单词" : "短语"
                            }</p>
                        </div>
                    `;
            return;
          }

          let filteredWords = this.showOnlyUnfamiliar
            ? words.filter((word) => word.status === "unfamiliar")
            : words;

          if (filteredWords.length === 0 && this.showOnlyUnfamiliar) {
            wordsList.innerHTML = `
                        <div class="empty-state">
                            <h3>没有不熟悉的${
                              this.currentType === "words" ? "单词" : "短语"
                            }</h3>
                            <p>所有${
                              this.currentType === "words" ? "单词" : "短语"
                            }都已掌握</p>
                        </div>
                    `;
            return;
          }

          wordsList.innerHTML = filteredWords
            .map(
              (word) => `
                    <div class="word-card">
                        <div class="word-content">
                            <div class="word-text ${
                              this.hideMode === "english" ? "hidden" : ""
                            }" 
                                 onclick="this.classList.toggle('hidden')">
                                ${
                                  this.isLanguageSwitched
                                    ? word.chinese
                                    : word.english
                                }
                            </div>
                            <div class="word-text ${
                              this.hideMode === "chinese" ? "hidden" : ""
                            }" 
                                 onclick="this.classList.toggle('hidden')">
                                ${
                                  this.isLanguageSwitched
                                    ? word.english
                                    : word.chinese
                                }
                            </div>
                        </div>
                        <div class="word-actions">
                            <div class="status-buttons">
                                <button class="status-btn ${
                                  word.status === "familiar" ? "familiar" : ""
                                }" 
                                        onclick="app.updateWordStatus('${
                                          word.id
                                        }', 'familiar')" title="已掌握">
                                    ✓
                                </button>
                                <button class="status-btn ${
                                  word.status === "unfamiliar"
                                    ? "unfamiliar"
                                    : ""
                                }" 
                                        onclick="app.updateWordStatus('${
                                          word.id
                                        }', 'unfamiliar')" title="不熟悉">
                                    ✗
                                </button>
                            </div>
                            <button class="delete-btn" onclick="app.deleteWord('${
                              word.id
                            }')" title="删除">
                                🗑
                            </button>
                        </div>
                    </div>
                `
            )
            .join("");
        }

        updateStats(words) {
          const total = words.length;
          const familiar = words.filter(
            (word) => word.status === "familiar"
          ).length;
          const unfamiliar = words.filter(
            (word) => word.status === "unfamiliar"
          ).length;

          document.getElementById("totalWords").textContent = total;
          document.getElementById("familiarWords").textContent = familiar;
          document.getElementById("unfamiliarWords").textContent = unfamiliar;
        }

        showAddWordForm() {
          document.getElementById("addWordForm").classList.add("show");
          document.getElementById("englishWord").focus();
        }

        hideAddWordForm() {
          document.getElementById("addWordForm").classList.remove("show");
          document.getElementById("englishWord").value = "";
          document.getElementById("chineseMeaning").value = "";
        }

        async addWord() {
          const english = document.getElementById("englishWord").value.trim();
          const chinese = document
            .getElementById("chineseMeaning")
            .value.trim();

          if (!english || !chinese) {
            alert(
              `请填写完整的${
                this.currentType === "words" ? "单词" : "短语"
              }信息`
            );
            return;
          }

          const word = {
            id: Date.now().toString(),
            english,
            chinese,
            status: "unfamiliar",
            createdAt: new Date().toISOString(),
          };

          if (!this.data[this.currentType][this.currentGroup]) {
            this.data[this.currentType][this.currentGroup] = [];
          }

          this.data[this.currentType][this.currentGroup].push(word);
          await this.saveData();
          this.displayContent();
          this.hideAddWordForm();
        }

        async updateWordStatus(wordId, status) {
          const words = this.data[this.currentType][this.currentGroup];
          const word = words.find((w) => w.id === wordId);
          if (word) {
            word.status = word.status === status ? "neutral" : status;
            await this.saveData();
            this.displayContent();
          }
        }

        async deleteWord(wordId) {
          if (
            !confirm(
              "确定要删除这个" +
                (this.currentType === "words" ? "单词" : "短语") +
                "吗？"
            )
          ) {
            return;
          }

          const words = this.data[this.currentType][this.currentGroup];
          const index = words.findIndex((w) => w.id === wordId);
          if (index !== -1) {
            words.splice(index, 1);
            await this.saveData();
            this.displayContent();
          }
        }

        toggleHideMode(mode) {
          this.hideMode = this.hideMode === mode ? "none" : mode;

          document
            .getElementById("hideChinese")
            .classList.toggle("active", this.hideMode === "chinese");
          document
            .getElementById("hideEnglish")
            .classList.toggle("active", this.hideMode === "english");

          this.displayContent();
        }

        switchLanguage() {
          this.isLanguageSwitched = !this.isLanguageSwitched;
          document
            .getElementById("switchLang")
            .classList.toggle("active", this.isLanguageSwitched);
          this.displayContent();
        }

        toggleUnfamiliarFilter() {
          this.showOnlyUnfamiliar = !this.showOnlyUnfamiliar;
          document
            .getElementById("filterBtn")
            .classList.toggle("active", this.showOnlyUnfamiliar);
          this.displayContent();
        }

        async saveData() {
          // 本地存储
          localStorage.setItem(
            "vocabularyWords",
            JSON.stringify(this.data.words)
          );
          localStorage.setItem(
            "vocabularyPhrases",
            JSON.stringify(this.data.phrases)
          );

          // GitHub 同步
          if (this.githubToken && this.githubRepo && !this.syncInProgress) {
            await this.syncToGitHub();
          }
        }

        setupGitHubSync() {
          // 启动时从GitHub加载数据
          if (this.githubToken && this.githubRepo) {
            this.loadFromGitHub();
          }

          // 定期同步（可选）
          setInterval(() => {
            if (this.githubToken && this.githubRepo && !this.syncInProgress) {
              this.loadFromGitHub();
            }
          }, 30000); // 30秒检查一次
        }

        async syncToGitHub() {
          if (this.syncInProgress) return;

          this.syncInProgress = true;
          this.updateSyncStatus("syncing", "同步中...");

          try {
            const data = {
              words: this.data.words,
              phrases: this.data.phrases,
              lastModified: new Date().toISOString(),
            };

            // 检查仓库是否存在，不存在则创建
            const repoExists = await this.checkRepository();
            if (!repoExists) {
              await this.createRepository();
            }

            // 获取现有文件的SHA（如果存在）
            let sha = null;
            try {
              const response = await fetch(
                `https://api.github.com/repos/${this.githubRepo}/contents/vocabulary.json`,
                {
                  headers: {
                    Authorization: `token ${this.githubToken}`,
                    Accept: "application/vnd.github.v3+json",
                  },
                }
              );

              if (response.ok) {
                const fileData = await response.json();
                sha = fileData.sha;
              }
            } catch (e) {
              // 文件不存在，继续创建
            }

            // 上传/更新文件
            const content = btoa(
              unescape(encodeURIComponent(JSON.stringify(data, null, 2)))
            );
            const uploadData = {
              message: `更新词汇数据 - ${new Date().toLocaleString("zh-CN")}`,
              content: content,
            };

            if (sha) {
              uploadData.sha = sha;
            }

            const uploadResponse = await fetch(
              `https://api.github.com/repos/${this.githubRepo}/contents/vocabulary.json`,
              {
                method: "PUT",
                headers: {
                  Authorization: `token ${this.githubToken}`,
                  Accept: "application/vnd.github.v3+json",
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(uploadData),
              }
            );

            if (uploadResponse.ok) {
              this.updateSyncStatus("synced", "已同步");
            } else {
              throw new Error(`上传失败: ${uploadResponse.status}`);
            }
          } catch (error) {
            console.error("GitHub同步失败:", error);
            this.updateSyncStatus("error", "同步失败");
          } finally {
            this.syncInProgress = false;
          }
        }

        async loadFromGitHub() {
          if (this.syncInProgress) return;

          try {
            const response = await fetch(
              `https://api.github.com/repos/${this.githubRepo}/contents/vocabulary.json`,
              {
                headers: {
                  Authorization: `token ${this.githubToken}`,
                  Accept: "application/vnd.github.v3+json",
                },
              }
            );

            if (response.ok) {
              const fileData = await response.json();
              const content = JSON.parse(
                decodeURIComponent(escape(atob(fileData.content)))
              );

              // 合并数据（保留本地较新的数据）
              if (content.words) {
                this.mergeData("words", content.words);
              }
              if (content.phrases) {
                this.mergeData("phrases", content.phrases);
              }

              // 更新本地存储
              localStorage.setItem(
                "vocabularyWords",
                JSON.stringify(this.data.words)
              );
              localStorage.setItem(
                "vocabularyPhrases",
                JSON.stringify(this.data.phrases)
              );

              // 刷新界面
              this.updateGroupList();
              this.displayContent();

              this.updateSyncStatus("synced", "已同步");
            }
          } catch (error) {
            console.error("从GitHub加载数据失败:", error);
          }
        }

        mergeData(type, remoteData) {
          const localData = this.data[type];

          for (const [groupName, remoteWords] of Object.entries(remoteData)) {
            if (!localData[groupName]) {
              localData[groupName] = remoteWords;
            } else {
              // 合并单词，优先保留较新的版本
              const localWords = localData[groupName];
              const mergedWords = [...localWords];

              remoteWords.forEach((remoteWord) => {
                const existingIndex = mergedWords.findIndex(
                  (w) => w.id === remoteWord.id
                );
                if (existingIndex === -1) {
                  mergedWords.push(remoteWord);
                } else {
                  // 比较修改时间，保留较新的
                  const localWord = mergedWords[existingIndex];
                  const remoteTime = new Date(remoteWord.createdAt || 0);
                  const localTime = new Date(localWord.createdAt || 0);

                  if (remoteTime > localTime) {
                    mergedWords[existingIndex] = remoteWord;
                  }
                }
              });

              localData[groupName] = mergedWords;
            }
          }
        }

        async checkRepository() {
          try {
            const response = await fetch(
              `https://api.github.com/repos/${this.githubRepo}`,
              {
                headers: {
                  Authorization: `token ${this.githubToken}`,
                  Accept: "application/vnd.github.v3+json",
                },
              }
            );
            return response.ok;
          } catch (error) {
            return false;
          }
        }

        async createRepository() {
          const repoName = this.githubRepo.split("/")[1];

          try {
            const response = await fetch("https://api.github.com/user/repos", {
              method: "POST",
              headers: {
                Authorization: `token ${this.githubToken}`,
                Accept: "application/vnd.github.v3+json",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                name: repoName,
                description: "词汇学习数据存储",
                private: true,
                auto_init: true,
              }),
            });

            if (!response.ok) {
              throw new Error(`创建仓库失败: ${response.status}`);
            }
          } catch (error) {
            console.error("创建GitHub仓库失败:", error);
            throw error;
          }
        }

        updateSyncStatus(status, text) {
          const syncStatus = document.getElementById("syncStatus");
          syncStatus.className = `sync-status ${status}`;
          syncStatus.textContent = text;

          // 3秒后恢复默认状态
          if (status === "synced" || status === "error") {
            setTimeout(() => {
              syncStatus.className = "sync-status";
              syncStatus.textContent = "已配置同步";
            }, 3000);
          }
        }
      }

      // 全局函数（保持与HTML的兼容性）
      let app;

      window.addEventListener("DOMContentLoaded", () => {
        app = new VocabularyApp();
      });

      function showAddGroupModal() {
        app.showAddGroupModal();
      }

      function hideAddGroupModal() {
        app.hideAddGroupModal();
      }

      function addGroup() {
        app.addGroup();
      }

      function addWord() {
        app.addWord();
      }

      function hideAddWordForm() {
        app.hideAddWordForm();
      }

      function toggleHideMode(mode) {
        app.toggleHideMode(mode);
      }

      function switchLanguage() {
        app.switchLanguage();
      }

      function toggleUnfamiliarFilter() {
        app.toggleUnfamiliarFilter();
      }
    </script>
  </body>
</html>
